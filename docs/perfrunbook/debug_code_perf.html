<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Debugging performance — “What part of the code is slow?” - AWS Graviton technical guide</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Technical guidance for developers to use the Arm based AWS Graviton instances">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">AWS Graviton technical guide</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/aws/aws-graviton-getting-started" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="debugging-performance--what-part-of-the-code-is-slow"><a class="header" href="#debugging-performance--what-part-of-the-code-is-slow">Debugging performance — “What part of the code is slow?”</a></h1>
<p><a href="./README.html">Graviton Performance Runbook toplevel</a></p>
<p>If after checking the system behavior with the sysstat tools the behavior of your code on the CPU is still different, then your next step is to generate code profiles. There are two primary types of profiles</p>
<h2 id="on-cpu-profiling"><a class="header" href="#on-cpu-profiling">On-cpu profiling</a></h2>
<p>If you see that Graviton is consuming more CPU-time than expected, on-cpu profiling can help find what is taking more time.  On-cpu profiling statistically measures what code is consuming time on the CPU by periodically sampling stack traces on the SUT.  We provide a utility to collect CPU profiles and emit a flamegraph, which is a graphical representation to show the percentage of execution time consumed by a particular stack-trace.  The x-axis represents percentage of execution time, and the y-axis is stack depth. These are particularly useful for finding differences in function execution times between two platforms.  To collect flamegraphs of on-cpu profiling, do the following:</p>
<ol>
<li>Verify native code is built with <code>-g -fno-omit-frame-pointer</code></li>
<li>Verify java code is started with <code>-XX:+PreserveFramePointer -agentpath:/usr/lib64/libperf-jvmti.so</code></li>
<li>Verify NodeJS code is started with <code>--perf-basic-prof</code></li>
<li>Collect the Flamegraph</li>
</ol>
<pre><code class="language-bash"># In terminal one on SUT/load-gen
%&gt; &lt;start load generator or benchmark&gt;
  
# In terminal two on SUT
cd ~/aws-graviton-getting-started/perfrunbook/utilities
sudo ./capture_flamegraphs.sh oncpu 300
  
# You will see a file saved in the following format:
# flamegraph_oncpu_&lt;instance id&gt;_&lt;instance type&gt;_&lt;date&gt;.svg
  
# In terminal three on your local machine
%&gt; scp "&lt;username&gt;@&lt;instance-ip&gt;:~/flamegraph_oncpu_*.svg" .
%&gt; open /path/to/flamegraph_oncpu_*.svg
</code></pre>
<ol start="5">
<li>Example on-cpu flamegraph:
<img src="images/oncpu_example_flamgraph.png" alt="" /></li>
<li>Look for the most expensive functions and then compare with a flamegraph gathered from the x86 test system.</li>
<li>If you find an expensive function that is not expensive on your x86 system, proceed to <a href="./optimization_recommendation.html">Section 6</a> for Optimization recommendations.</li>
</ol>
<h3 id="on-cpu-profiling-using-pseudo-non-maskable-interrupts-nmi"><a class="header" href="#on-cpu-profiling-using-pseudo-non-maskable-interrupts-nmi">On-cpu profiling using Pseudo Non-maskable-interrupts (NMI)</a></h3>
<p>If your on-cpu profiling reveals the hot code is in the kernel, you may see issues with measuring code-paths that run in non-preemptible sections of Linux.  This usually manifests as small functions such as <code>arch_local_irq_restore</code> in the kernel showing high overhead.  Functions like this are un-masking interrupts, such as the interrupt <code>perf</code> uses to trigger taking a sample stack trace, and since the interrupt may have
already been queued, <code>perf</code> will record IRQ unmasking functions as hot because that is when IRQs are re-enabled.  To collect profiles of kernel functions that are inside interrupt masked portions of code on Graviton you can enable <code>perf</code> to use a pseudo Non-maskable-interrupt to measure inside non-preemptible regions. To enable this, do the following:</p>
<ol>
<li>Ensure <code>CONFIG_ARM64_PSEUDO_NMI</code> is enabled in your kernel configuration</li>
<li>Enable <code>irqchip.gicv3_pseudo_nmi=1</code> on the kernel command line and reboot.</li>
<li>Collect a Flamegraph:</li>
</ol>
<pre><code class="language-bash"># In terminal on SUT
cd ~/aws-graviton-getting-started/perfrunbook/utilities
# Use a custome event from the PMU such as r11 (cycles) or r8 (instructions)
sudo ./capture_flamegraphs.sh r11 300
</code></pre>
<ol start="4">
<li>Double check you are using a PMU hardware-event, if you do not see a change in your profiles. Events that do not come from the cpu PMU, such as <code>cpu-clock</code>, can not utilize the pseudo-NMI feature on Graviton.</li>
<li>Be aware code using hardware events such as cycles (r11) will under-count idle time as Graviton uses a clock-gated sleep state during idle on Linux, meaning hardware events will not tick.</li>
</ol>
<p>You may see a small single-digit percent increase in overhead with pseudo-NMI enabled, but this is expected.  We recommend only turning on pseudo-NMI when needed.</p>
<h2 id="off-cpu-profiling"><a class="header" href="#off-cpu-profiling">Off-cpu profiling</a></h2>
<p>If Graviton is consuming less CPU-time than expected, it is useful to find call-stacks that are putting <em>threads</em> to sleep via the OS.  Lock contention, IO Bottlenecks, OS scheduler issues can all lead to cases where performance is lower, but the CPU is not being fully utilized.   The method to look for what might be causing more off-cpu time is the same as with looking for functions consuming more on-cpu time: generate a flamegraph and compare.  In this case, the differences are more subtle to look for as small differences can mean large swings in performance as more thread sleeps can induce milli-seconds of wasted execution time.</p>
<ol>
<li>Verify native (i.e. C/C++/Rust) code is built with <code>-fno-omit-frame-pointer</code></li>
<li>Verify java code is started with <code>-XX:+PreserveFramePointer -agentpath:/path/to/libperf-jvmti.so</code>
<ol>
<li>The <code>libperf-jvmti.so</code> library is usually provided when <code>perf</code> is installed.  If it is not, see <a href="https://github.com/aws/aws-graviton-getting-started/blob/main/java.md#build-libperf-jvmtiso-on-amazon-linux-2">how to build the jvmti from source</a> in our getting-started guide.</li>
<li>Additional debugging information can be extracted by adding <code>-XX:+UnlockDiagnosticVMOptions -XX:+DebugNonSafepoints</code> to the java command line.</li>
</ol>
</li>
<li>Verify NodeJS code is started with <code>--perf-basic-prof</code></li>
<li>Collect the Flamegraph:</li>
</ol>
<pre><code class="language-bash"># In terminal one on SUT/load-gen
%&gt; &lt;start load generator or benchmark&gt;
  
# In terminal two on SUT
cd ~/aws-graviton-getting-started/perfrunbook/utilities
sudo ./capture_flamegraphs.sh offcpu 300
  
# You will see a file saved in the following format:
# flamegraph_oncpu_&lt;instance id&gt;_&lt;instance type&gt;_&lt;date&gt;.svg
  
# In terminal three on your local machine
%&gt; scp "&lt;username&gt;@&lt;instance-ip&gt;:~/flamegraph_oncpu_*.svg" .
%&gt; open /path/to/flamegraph_offcpu.svg
</code></pre>
<ol start="5">
<li>Inspect the flamegraphs for which code paths cause extra sleeps compared to x86:
<ol>
<li>Look at sleeps induced by to IO like <code>read</code>, <code>write</code>, and <code>epoll</code> system calls, do they happen more often?</li>
<li>Look at sleeps induced by callpaths that contain keywords such as: <code>lock</code>, <code>mutex</code>, <code>semaphore</code>, <code>synchronize</code>, <code>futex</code>. Determine if these are happening more often than on x86.</li>
<li>Disregard call-stacks that include <code>work_pending</code>. These indicate the CPU was involuntarily switched and can be ignored.</li>
</ol>
</li>
<li>If you find that there are code paths that are sleeping more than expected, proceed to <a href="./optimization_recommendation.html">Section 6 for Optimization recommendations</a>.</li>
</ol>
<h2 id="additional-profiling-tips"><a class="header" href="#additional-profiling-tips">Additional profiling tips</a></h2>
<p>In our <code>capture_flamegraphs.sh</code> helper script, we use <code>perf record</code> to gather traces.  The script can be modified to collect different views of the same data to help dig deeper and root cause the reason for a detected performance issue on Graviton.</p>
<ol>
<li>To aide in spotting differences between two flamegraphs, you can use a flamegraph diff between <code>perf</code> data on x86 and Graviton</li>
</ol>
<pre><code class="language-bash"># On load generation instance
%&gt; &lt;start test&gt;
  
# x86 SUT
perf record -a -g -k 1 -F99 -e cpu-clock:pppH -- sleep
perf script -f -i perf.data &gt; x86_script.out
./FlameGraph/stackcollapse-perf.pl --kernel --jit x86_script.out &gt; x86_folded.out
  
# Graviton SUT
perf record -a -g -k 1 -F99 -e cpu-clock:pppH -- sleep
perf script -f -i perf.data &gt; grv_script.out
./FlameGraph/stackcollapse-perf.pl --kernel --jit grv_script.out &gt; grv_folded.out
# Copy x86_folded.out to Graviton SUT
./FlameGraph/difffolded.pl grv_folded.out x86_folded.out &gt; diff.out
./FlameGraph/flamegraph.pl --colors java diff.out &gt; flamegraph-diff.svg
</code></pre>
<ol start="2">
<li>View the diff — red regions indicate an increase in the proportion of execution time, blue a decrease. Note: diffing call-stacks between different architectures can lead to peculiar artifacts due to machine specific functions being named differently.</li>
<li>Create flame-graphs from <code>perf record</code>  that use different events than the cpu-clock to determine when to sample stack traces. This can help uncover different root causes and potential optimization opportunities.  Examples below:
<ol>
<li>Use <code>-e instructions</code> to generate a flame-graph of the functions that use the most instructions on average to identify a compiler or code optimization opportunity.</li>
<li>Use <code>-e cache-misses</code> to generate a flame-graph of functions that miss the L1 cache the most to indicate if changing to a more efficient data-structure might be necessary.</li>
<li>Use <code>-e branch-misses</code> to generate a flame-graph of functions that cause the CPU to mis-speculate.  This may identify regions with heavy use of conditionals, or conditionals that are data-dependent and may be a candidate for refactoring.</li>
</ol>
</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../perfrunbook/debug_system_perf.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../perfrunbook/debug_hw_perf.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../perfrunbook/debug_system_perf.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../perfrunbook/debug_hw_perf.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
